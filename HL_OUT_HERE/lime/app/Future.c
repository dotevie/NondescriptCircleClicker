// Generated by HLC 4.3.1 (HL v5)
#define HLC_BOOT
#include <hlc.h>
#include <lime/app/Future.h>
extern hl_type t$lime_app_Promise;
void lime_app_Promise_new(lime__app__Promise);
extern hl_type t$vrt_9177929;
extern hl_type t$fun_32f7ff2;
void lime_app__Future_FutureWork_queue(vdynamic*);
lime__app__Promise lime_app_Promise_complete(lime__app__Promise,vdynamic*);
lime__app__Promise lime_app_Promise_error(lime__app__Promise,vdynamic*);
lime__app__Promise lime_app_Promise_progress(lime__app__Promise,int,int);
extern hl_type t$fun_7bc0547;
void lime_app__Event_ofEvents_T_Void_add(lime__app___Event_ofEvents_T_Void,vdynamic*,bool*,int*);
void lime_app__Event_Dynamic_Void_add(lime__app___Event_Dynamic_Void,vdynamic*,bool*,int*);
extern hl_type t$fun_6c1e3a6;
void lime_app__Event_Int_Int_Void_add(lime__app___Event_Int_Int_Void,vdynamic*,bool*,int*);
extern hl_type t$hl_types_ArrayObj;
void hl_types_ArrayObj_new(hl__types__ArrayObj);
int hl_types_ArrayObj_push(hl__types__ArrayObj,vdynamic*);
int lime_system_System_getTimer(void);
#include <hl/natives.h>
extern hl_type t$fun_2b2a2eb;
void wrapt$fun_e2ed85b(vclosure*,vdynamic*);
extern hl_type t$fun_e2ed85b;
extern hl_type t$lime_app_Future;
extern hl_type t$fun_a4fdf42;
void wrapt$fun_354f561(vclosure*,int,int);
extern hl_type t$fun_354f561;
extern hl_type t$ctx_e773f08;
extern hl_type t$fun_81eb599;

void lime_app_Future_new(lime__app__Future r0,vclosure* r1,bool* r2) {
	vvirtual *r7;
	bool r3, r5;
	lime__app__Promise r6;
	vdynamic *r8, *r9;
	hl_trap_ctx trap$0;
	if( r2 ) goto label$860abfd_1_3;
	r3 = false;
	goto label$860abfd_1_4;
	label$860abfd_1_3:
	r3 = *r2;
	label$860abfd_1_4:
	if( !r1 ) goto label$860abfd_1_26;
	if( !r3 ) goto label$860abfd_1_14;
	r6 = (lime__app__Promise)hl_alloc_obj(&t$lime_app_Promise);
	lime_app_Promise_new(r6);
	r6->future = r0;
	r7 = hl_alloc_virtual(&t$vrt_9177929);
	if( hl_vfields(r7)[0] ) *(lime__app__Promise*)(hl_vfields(r7)[0]) = (lime__app__Promise)r6; else hl_dyn_setp(r7->value,-135672421/*promise*/,&t$lime_app_Promise,r6);
	if( hl_vfields(r7)[1] ) *(vclosure**)(hl_vfields(r7)[1]) = (vclosure*)r1; else hl_dyn_setp(r7->value,251462363/*work*/,&t$fun_32f7ff2,r1);
	lime_app__Future_FutureWork_queue(((vdynamic*)r7));
	goto label$860abfd_1_26;
	label$860abfd_1_14:
	hl_trap(trap$0,r8,label$860abfd_1_22);
	if( r1 == NULL ) hl_null_access();
	r8 = r1->hasValue ? ((vdynamic* (*)(vdynamic*))r1->fun)((vdynamic*)r1->value) : ((vdynamic* (*)(void))r1->fun)();
	r0->value = r8;
	r5 = true;
	r0->isComplete = r5;
	hl_endtrap(trap$0);
	goto label$860abfd_1_26;
	label$860abfd_1_22:
	r9 = NULL;
	r0->error = r8;
	r5 = true;
	r0->isError = r5;
	label$860abfd_1_26:
	return;
}

void lime_app_Future_ofEvents__$1(lime__app__Promise r0,vdynamic* r1) {
	lime__app__Promise r2;
	if( r0 == NULL ) hl_null_access();
	r2 = lime_app_Promise_complete(r0,r1);
	return;
}

void lime_app_Future_ofEvents__$2(lime__app__Promise r0,vdynamic* r1) {
	lime__app__Promise r2;
	if( r0 == NULL ) hl_null_access();
	r2 = lime_app_Promise_error(r0,r1);
	return;
}

void lime_app_Future_ofEvents__$3(lime__app__Promise r0,int r1,int r2) {
	lime__app__Promise r3;
	if( r0 == NULL ) hl_null_access();
	r3 = lime_app_Promise_progress(r0,r1,r2);
	return;
}

lime__app__Future lime_app_Future_ofEvents(lime__app___Event_ofEvents_T_Void r0,lime__app___Event_Dynamic_Void r1,lime__app___Event_Int_Int_Void r2) {
	bool *r7;
	bool r6, r9, r11;
	lime__app__Future r12;
	lime__app__Promise r3;
	vclosure *r5, *r10;
	int *r8;
	r3 = (lime__app__Promise)hl_alloc_obj(&t$lime_app_Promise);
	lime_app_Promise_new(r3);
	if( r0 == NULL ) hl_null_access();
	r5 = hl_alloc_closure_ptr(&t$fun_7bc0547,lime_app_Future_ofEvents__$1,r3);
	r6 = true;
	r7 = &r6;
	r8 = NULL;
	lime_app__Event_ofEvents_T_Void_add(r0,((vdynamic*)r5),r7,r8);
	if( !r1 ) goto label$860abfd_5_15;
	if( r1 == NULL ) hl_null_access();
	r5 = hl_alloc_closure_ptr(&t$fun_7bc0547,lime_app_Future_ofEvents__$2,r3);
	r9 = true;
	r7 = &r9;
	r8 = NULL;
	lime_app__Event_Dynamic_Void_add(r1,((vdynamic*)r5),r7,r8);
	label$860abfd_5_15:
	if( !r2 ) goto label$860abfd_5_22;
	if( r2 == NULL ) hl_null_access();
	r10 = hl_alloc_closure_ptr(&t$fun_6c1e3a6,lime_app_Future_ofEvents__$3,r3);
	r11 = true;
	r7 = &r11;
	r8 = NULL;
	lime_app__Event_Int_Int_Void_add(r2,((vdynamic*)r10),r7,r8);
	label$860abfd_5_22:
	r12 = r3->future;
	return r12;
}

lime__app__Future lime_app_Future_onComplete(lime__app__Future r0,vclosure* r1) {
	hl__types__ArrayObj r5;
	bool r3;
	vdynamic *r4;
	int r6;
	if( !r1 ) goto label$860abfd_6_17;
	r3 = r0->isComplete;
	if( !r3 ) goto label$860abfd_6_7;
	if( r1 == NULL ) hl_null_access();
	r4 = r0->value;
	r1->hasValue ? ((void (*)(vdynamic*,vdynamic*))r1->fun)((vdynamic*)r1->value,r4) : ((void (*)(vdynamic*))r1->fun)(r4);
	goto label$860abfd_6_17;
	label$860abfd_6_7:
	r3 = r0->isError;
	if( r3 ) goto label$860abfd_6_17;
	r5 = r0->__completeListeners;
	if( r5 ) goto label$860abfd_6_14;
	r5 = (hl__types__ArrayObj)hl_alloc_obj(&t$hl_types_ArrayObj);
	hl_types_ArrayObj_new(r5);
	r0->__completeListeners = r5;
	label$860abfd_6_14:
	r5 = r0->__completeListeners;
	if( r5 == NULL ) hl_null_access();
	r6 = hl_types_ArrayObj_push(r5,((vdynamic*)r1));
	label$860abfd_6_17:
	return r0;
}

lime__app__Future lime_app_Future_onError(lime__app__Future r0,vclosure* r1) {
	hl__types__ArrayObj r5;
	bool r3;
	vdynamic *r4;
	int r6;
	if( !r1 ) goto label$860abfd_7_17;
	r3 = r0->isError;
	if( !r3 ) goto label$860abfd_7_7;
	if( r1 == NULL ) hl_null_access();
	r4 = r0->error;
	r1->hasValue ? ((void (*)(vdynamic*,vdynamic*))r1->fun)((vdynamic*)r1->value,r4) : ((void (*)(vdynamic*))r1->fun)(r4);
	goto label$860abfd_7_17;
	label$860abfd_7_7:
	r3 = r0->isComplete;
	if( r3 ) goto label$860abfd_7_17;
	r5 = r0->__errorListeners;
	if( r5 ) goto label$860abfd_7_14;
	r5 = (hl__types__ArrayObj)hl_alloc_obj(&t$hl_types_ArrayObj);
	hl_types_ArrayObj_new(r5);
	r0->__errorListeners = r5;
	label$860abfd_7_14:
	r5 = r0->__errorListeners;
	if( r5 == NULL ) hl_null_access();
	r6 = hl_types_ArrayObj_push(r5,((vdynamic*)r1));
	label$860abfd_7_17:
	return r0;
}

lime__app__Future lime_app_Future_onProgress(lime__app__Future r0,vclosure* r1) {
	hl__types__ArrayObj r3;
	int r4;
	if( !r1 ) goto label$860abfd_8_9;
	r3 = r0->__progressListeners;
	if( r3 ) goto label$860abfd_8_6;
	r3 = (hl__types__ArrayObj)hl_alloc_obj(&t$hl_types_ArrayObj);
	hl_types_ArrayObj_new(r3);
	r0->__progressListeners = r3;
	label$860abfd_8_6:
	r3 = r0->__progressListeners;
	if( r3 == NULL ) hl_null_access();
	r4 = hl_types_ArrayObj_push(r3,((vdynamic*)r1));
	label$860abfd_8_9:
	return r0;
}

lime__app__Future lime_app_Future_ready(lime__app__Future r0,int* r1) {
	bool r4;
	double r8;
	int r2, r5, r6, r7;
	if( r1 ) goto label$860abfd_9_3;
	r2 = -1;
	goto label$860abfd_9_4;
	label$860abfd_9_3:
	r2 = *r1;
	label$860abfd_9_4:
	r4 = r0->isComplete;
	if( r4 ) goto label$860abfd_9_8;
	r4 = r0->isError;
	if( !r4 ) goto label$860abfd_9_9;
	label$860abfd_9_8:
	return r0;
	label$860abfd_9_9:
	r5 = lime_system_System_getTimer();
	r6 = r5 + r2;
	label$860abfd_9_11:
	r4 = r0->isComplete;
	if( r4 ) goto label$860abfd_9_22;
	r4 = r0->isError;
	if( r4 ) goto label$860abfd_9_22;
	if( r6 < r5 ) goto label$860abfd_9_22;
	r8 = 0.01;
	hl_sys_sleep(r8);
	r7 = lime_system_System_getTimer();
	r5 = r7;
	goto label$860abfd_9_11;
	label$860abfd_9_22:
	return r0;
}

vdynamic* lime_app_Future_result(lime__app__Future r0,int* r1) {
	bool r5;
	lime__app__Future r3;
	vdynamic *r6;
	int r2, r4;
	if( r1 ) goto label$860abfd_10_3;
	r2 = -1;
	goto label$860abfd_10_4;
	label$860abfd_10_3:
	r2 = *r1;
	label$860abfd_10_4:
	r4 = r2;
	r1 = &r4;
	r3 = lime_app_Future_ready(r0,r1);
	r5 = r0->isComplete;
	if( !r5 ) goto label$860abfd_10_11;
	r6 = r0->value;
	return r6;
	label$860abfd_10_11:
	r6 = NULL;
	return r6;
}

void lime_app_Future_then__$1(venum* r0,vdynamic* r1) {
	lime__app__Future r2, r5;
	lime__app__Promise r7;
	vclosure *r3, *r6, *r8;
	r3 = ((Enumt$ctx_e773f08*)r0)->p0;
	if( r3 == NULL ) hl_null_access();
	r2 = r3->hasValue ? ((lime__app__Future (*)(vdynamic*,vdynamic*))r3->fun)((vdynamic*)r3->value,r1) : ((lime__app__Future (*)(vdynamic*))r3->fun)(r1);
	if( r2 == NULL ) hl_null_access();
	r7 = ((Enumt$ctx_e773f08*)r0)->p1;
	if( r7 == NULL ) hl_null_access();
	r6 = hl_alloc_closure_ptr(&t$fun_2b2a2eb,lime_app_Promise_error,r7);
	if( r6 ) goto label$860abfd_11_10;
	r8 = NULL;
	goto label$860abfd_11_11;
	label$860abfd_11_10:
	r8 = hl_alloc_closure_ptr(&t$fun_e2ed85b,wrapt$fun_e2ed85b,r6);
	label$860abfd_11_11:
	r5 = lime_app_Future_onError(r2,r8);
	r7 = ((Enumt$ctx_e773f08*)r0)->p1;
	if( r7 == NULL ) hl_null_access();
	r6 = hl_alloc_closure_ptr(&t$fun_2b2a2eb,lime_app_Promise_complete,r7);
	if( r6 ) goto label$860abfd_11_18;
	r8 = NULL;
	goto label$860abfd_11_19;
	label$860abfd_11_18:
	r8 = hl_alloc_closure_ptr(&t$fun_e2ed85b,wrapt$fun_e2ed85b,r6);
	label$860abfd_11_19:
	r5 = lime_app_Future_onComplete(r2,r8);
	return;
}

lime__app__Future lime_app_Future_then(lime__app__Future r0,vclosure* r1) {
	bool *r7;
	venum *r13;
	bool r3;
	lime__app__Future r4;
	lime__app__Promise r8;
	vclosure *r6, *r9, *r10, *r11, *r12;
	vdynamic *r5;
	r3 = r0->isComplete;
	if( !r3 ) goto label$860abfd_12_6;
	if( r1 == NULL ) hl_null_access();
	r5 = r0->value;
	r4 = r1->hasValue ? ((lime__app__Future (*)(vdynamic*,vdynamic*))r1->fun)((vdynamic*)r1->value,r5) : ((lime__app__Future (*)(vdynamic*))r1->fun)(r5);
	return r4;
	label$860abfd_12_6:
	r3 = r0->isError;
	if( !r3 ) goto label$860abfd_12_17;
	r4 = (lime__app__Future)hl_alloc_obj(&t$lime_app_Future);
	r6 = NULL;
	r7 = NULL;
	lime_app_Future_new(r4,r6,r7);
	r3 = true;
	r4->isError = r3;
	r5 = r0->error;
	r4->error = r5;
	return r4;
	label$860abfd_12_17:
	r8 = (lime__app__Promise)hl_alloc_obj(&t$lime_app_Promise);
	lime_app_Promise_new(r8);
	r9 = hl_alloc_closure_ptr(&t$fun_2b2a2eb,lime_app_Promise_error,r8);
	if( r9 ) goto label$860abfd_12_23;
	r10 = NULL;
	goto label$860abfd_12_24;
	label$860abfd_12_23:
	r10 = hl_alloc_closure_ptr(&t$fun_e2ed85b,wrapt$fun_e2ed85b,r9);
	label$860abfd_12_24:
	r4 = lime_app_Future_onError(r0,r10);
	r11 = hl_alloc_closure_ptr(&t$fun_a4fdf42,lime_app_Promise_progress,r8);
	if( r11 ) goto label$860abfd_12_29;
	r12 = NULL;
	goto label$860abfd_12_30;
	label$860abfd_12_29:
	r12 = hl_alloc_closure_ptr(&t$fun_354f561,wrapt$fun_354f561,r11);
	label$860abfd_12_30:
	r4 = lime_app_Future_onProgress(r0,r12);
	r13 = hl_alloc_enum(&t$ctx_e773f08,0);
	((Enumt$ctx_e773f08*)r13)->p0 = (vclosure*)r1;
	((Enumt$ctx_e773f08*)r13)->p1 = (lime__app__Promise)r8;
	r10 = hl_alloc_closure_ptr(&t$fun_81eb599,lime_app_Future_then__$1,r13);
	r4 = lime_app_Future_onComplete(r0,r10);
	r4 = r8->future;
	return r4;
}

lime__app__Future lime_app_Future_withError(vdynamic* r0) {
	bool *r3;
	bool r5;
	lime__app__Future r1;
	vclosure *r2;
	r1 = (lime__app__Future)hl_alloc_obj(&t$lime_app_Future);
	r2 = NULL;
	r3 = NULL;
	lime_app_Future_new(r1,r2,r3);
	r5 = true;
	r1->isError = r5;
	r1->error = r0;
	return r1;
}

lime__app__Future lime_app_Future_withValue(vdynamic* r0) {
	bool *r3;
	bool r5;
	lime__app__Future r1;
	vclosure *r2;
	r1 = (lime__app__Future)hl_alloc_obj(&t$lime_app_Future);
	r2 = NULL;
	r3 = NULL;
	lime_app_Future_new(r1,r2,r3);
	r5 = true;
	r1->isComplete = r5;
	r1->value = r0;
	return r1;
}

